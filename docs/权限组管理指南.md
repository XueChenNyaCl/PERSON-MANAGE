# 权限组管理指南

## 概述
本系统采用LuckPerms风格的权限管理系统，支持通配符权限、优先级覆盖和细粒度权限控制。权限系统默认没有任何权限，需要通过API手动添加。

## 权限系统架构

### 数据库结构
系统使用两个主要表存储权限：

1. **permissions表** - 存储角色权限节点
   - `id` UUID 主键
   - `role` VARCHAR(50) 角色名称（admin, teacher, student, parent）
   - `permission` VARCHAR(255) 权限节点
   - `priority` INTEGER 优先级（值越大优先级越高）
   - `created_at` TIMESTAMP 创建时间
   - `updated_at` TIMESTAMP 更新时间

2. **user_permissions表** - 存储用户特定权限
   - `id` UUID 主键
   - `user_id` UUID 用户ID
   - `permission` VARCHAR(255) 权限节点
   - `value` BOOLEAN 权限值（true=允许，false=拒绝）
   - `priority` INTEGER 优先级（默认100，高于角色权限）
   - `created_at` TIMESTAMP 创建时间
   - `updated_at` TIMESTAMP 更新时间

### 权限节点格式
权限节点采用点分隔的字符串表示，支持以下格式：

1. **标准权限节点**：`module.action.target`
   - 示例：`person.view`、`class.update_teacher`

2. **通配符权限**：使用`*`匹配任意部分
   - 示例：`person.*` 匹配所有人员相关权限
   - 示例：`*.view` 匹配所有查看权限
   - 示例：`*.*` 匹配所有权限（慎用）

3. **否定权限**：以`-`开头表示拒绝权限
   - 示例：`-person.delete` 拒绝删除人员权限
   - 注意：否定权限优先级高于普通权限

### 权限评估规则
1. **优先级系统**：权限按优先级排序，优先级高的权限覆盖优先级低的权限
2. **继承关系**：用户权限继承自角色权限，用户特定权限可以覆盖角色权限
3. **否定权限**：否定权限（以`-`开头）直接拒绝访问，优先级高于允许权限
4. **通配符匹配**：通配符权限可以匹配多个具体权限
5. **默认行为**：如果没有匹配的权限节点，默认拒绝访问

## 预定义权限组

### 管理员权限组 (admin)
```yaml
# 系统管理权限
system.settings          # 系统设置
system.permissions       # 权限管理

# 人员管理权限
person.view              # 查看人员
person.manage            # 管理人员（增删改）
person.sensitive.view    # 查看敏感信息（学号、电话）

# 班级管理权限  
class.view               # 查看班级
class.manage             # 管理班级（增删改）
class.update_teacher     # 更新班主任

# 部门管理权限
department.view          # 查看部门
department.manage        # 管理部门（增删改）
department.update        # 更新部门信息

# 考勤管理权限
attendance.view          # 查看考勤
attendance.manage        # 管理考勤

# 成绩管理权限
score.view               # 查看成绩
score.manage             # 管理成绩

# 通知管理权限
notice.view              # 查看通知
notice.manage            # 管理通知

# 仪表板权限
dashboard.view           # 查看仪表板
```

### 教师权限组 (teacher)
```yaml
# 人员查看权限
person.view              # 查看人员
person.sensitive.view    # 查看敏感信息

# 班级管理权限
class.view               # 查看班级
class.manage             # 管理所教班级
class.update_teacher     # 更新班主任（仅限自己班级）

# 部门查看权限
department.view          # 查看部门

# 考勤管理权限
attendance.manage        # 管理考勤

# 成绩管理权限
score.manage             # 管理成绩

# 通知查看权限
notice.view              # 查看通知

# 仪表板权限
dashboard.view           # 查看仪表板
```

### 学生权限组 (student)
```yaml
# 基础查看权限
person.view              # 查看人员（不含敏感信息）
class.view               # 查看班级
attendance.view          # 查看考勤
score.view               # 查看成绩
notice.view              # 查看通知
dashboard.view           # 查看仪表板
```

### 家长权限组 (parent)
```yaml
# 基础查看权限
person.view              # 查看子女信息
class.view               # 查看子女班级
attendance.view          # 查看子女考勤
score.view               # 查看子女成绩
notice.view              # 查看通知
dashboard.view           # 查看仪表板
```

## API接口说明

### 权限管理API

#### 1. 获取所有角色权限
```
GET /api/permissions
```
**权限要求**：`system.settings`

**响应示例**：
```json
[
  {
    "role": "admin",
    "permissions": [
      {
        "permission": "person.view",
        "priority": 10,
        "created_at": "2026-02-26T10:30:00Z"
      }
    ]
  }
]
```

#### 2. 添加角色权限
```
POST /api/permissions
```
**权限要求**：`system.settings`

**请求体**：
```json
{
  "role": "teacher",
  "permission": "class.*",
  "priority": 5
}
```

#### 3. 移除角色权限
```
DELETE /api/permissions
```
**权限要求**：`system.settings`

**请求体**：
```json
{
  "role": "teacher",
  "permission": "class.delete"
}
```

#### 4. 检查权限
```
POST /api/permissions/check
```
**权限要求**：无（当前用户）

**请求体**：
```json
{
  "permission": "person.view"
}
```

**响应**：
```json
{
  "has_permission": true,
  "result": "allowed"
}
```

### 用户权限管理API

#### 1. 获取用户特定权限
```
GET /api/permissions/users/{user_id}
```
**权限要求**：管理员或用户本人

#### 2. 添加用户特定权限
```
POST /api/permissions/users/{user_id}
```
**权限要求**：管理员或用户本人

**请求体**：
```json
{
  "permission": "-person.delete",
  "value": false,
  "priority": 150
}
```

#### 3. 移除用户特定权限
```
DELETE /api/permissions/users/{user_id}?permission=person.delete
```
**权限要求**：管理员或用户本人

## 通配符权限示例

### 常用通配符模式
1. **`module.*`** - 模块所有权限
   - `person.*` - 所有人员权限
   - `class.*` - 所有班级权限

2. **`*.action`** - 所有模块的特定操作
   - `*.view` - 所有查看权限
   - `*.manage` - 所有管理权限

3. **`module.action.*`** - 模块操作的所有目标
   - `person.update.*` - 更新所有人员属性

### 通配符与否定权限结合
```yaml
# 允许所有查看权限
*.view

# 但拒绝查看敏感信息
-person.sensitive.view

# 允许所有班级权限
class.*

# 但拒绝删除班级
-class.delete
```

## 权限优先级示例

### 优先级覆盖示例
```yaml
# 角色权限（优先级10）
person.view = true

# 用户特定权限（优先级100）
-person.view = false

# 最终结果：用户无法查看人员（用户权限覆盖角色权限）
```

### 否定权限优先级
```yaml
# 通配符允许（优先级5）
person.* = true

# 具体拒绝（优先级10）
-person.delete = false

# 最终结果：用户有所有人员权限，但不能删除
```

## 最佳实践

### 1. 最小权限原则
- 默认不给任何权限
- 按需添加权限，而非一开始给全部权限
- 使用通配符简化管理，但要注意范围

### 2. 权限分组管理
- 按角色创建权限组
- 使用通配符减少重复配置
- 定期审查和清理无用权限

### 3. 权限测试
- 使用`/api/permissions/check`接口测试权限
- 在生产环境变更前先在测试环境验证
- 记录权限变更日志

### 4. 安全注意事项
- 否定权限优先级高，谨慎使用
- 通配符`*.*`会授予所有权限，慎用
- 用户特定权限优先级最高，注意管理

## 初始化脚本
系统提供了`run_permission_migration.rs`脚本用于初始化权限表。默认情况下，脚本会创建空表，需要手动添加权限。

如需初始化默认权限，可以取消注释脚本中的`init_default_permissions`函数调用。

## 故障排除

### 常见问题
1. **权限不生效**：检查权限优先级和否定权限
2. **通配符不匹配**：确认权限节点格式正确
3. **数据库错误**：检查权限表是否存在

### 调试方法
1. 使用`/api/permissions/check`接口测试权限
2. 查看数据库中的权限记录
3. 检查用户角色是否正确

## 版本历史
- v1.0 (2026-02-26)：初始版本，基于LuckPerms风格实现动态权限系统
- v1.1 (2026-02-26)：添加通配符支持和否定权限功能