# 人员管理功能说明

## 1. 功能概述

人员管理模块是系统的核心功能之一，用于管理学校的学生、教师和家长信息。主要功能包括：

- 人员信息的增删改查
- 学生与班级的关联管理
- 教师与班级的多对多关联管理
- 人员权限控制
- 班级学生和老师列表的获取

## 2. 数据模型

### 2.1 人员表 (`persons`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `id` | `UUID` | 人员唯一标识 |
| `name` | `VARCHAR` | 姓名 |
| `gender` | `SMALLINT` | 性别 (0:未知, 1:男, 2:女) |
| `birthday` | `DATE` | 出生日期 |
| `phone` | `VARCHAR` | 电话号码 |
| `email` | `VARCHAR` | 邮箱地址 |
| `type` | `VARCHAR` | 人员类型 ('student', 'teacher', 'parent') |
| `created_at` | `TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | 更新时间 |

### 2.2 学生表 (`students`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `person_id` | `UUID` | 关联人员ID |
| `student_no` | `VARCHAR` | 学号 |
| `class_id` | `UUID` | 关联班级ID |
| `enrollment_date` | `DATE` | 入学日期 |
| `status` | `VARCHAR` | 学生状态 |

### 2.3 教师表 (`teachers`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `person_id` | `UUID` | 关联人员ID |
| `employee_no` | `VARCHAR` | 工号 |
| `department_id` | `UUID` | 关联部门ID |
| `title` | `VARCHAR` | 职称 |
| `hire_date` | `DATE` | 入职日期 |

### 2.4 老师班级关联表 (`teacher_class`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `teacher_id` | `UUID` | 关联教师ID |
| `class_id` | `UUID` | 关联班级ID |
| `is_main_teacher` | `BOOLEAN` | 是否为主班主任 |

## 3. API接口说明

### 3.1 认证接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/auth/login` | `POST` | 用户登录，获取认证令牌 |

**请求参数**：
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应参数**：
```json
{
  "token": "JWT令牌",
  "user": {
    "id": "1",
    "username": "admin",
    "role": "admin"
  }
}
```

### 3.2 人员管理接口

#### 3.2.1 获取人员列表

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons` | `GET` | 获取人员列表，支持分页和筛选 |

**查询参数**：
- `page`：页码，默认1
- `limit`：每页数量，默认20
- `type`：人员类型，可选值：student, teacher, parent
- `search`：搜索关键词
- `class_id`：班级ID，用于筛选特定班级的学生
- `department_id`：部门ID，用于筛选特定部门的教师

**响应参数**：
```json
{
  "items": [
    {
      "type": "student",
      "id": "UUID",
      "name": "张三",
      "gender": 1,
      "birthday": "2005-01-01",
      "phone": "13800138000",
      "email": "zhangsan@example.com",
      "student_no": "20230001",
      "class_id": "UUID",
      "class_name": "高一(1)班",
      "enrollment_date": "2023-09-01",
      "status": "enrolled"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

#### 3.2.2 创建人员

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons` | `POST` | 创建新人员 |

**请求参数**：
```json
{
  "name": "李四",
  "gender": 1,
  "birthday": "1990-01-01",
  "phone": "13900139000",
  "email": "lisi@example.com",
  "type_": "teacher",
  "employee_no": "T20230001",
  "department_id": "UUID",
  "title": "高级教师",
  "hire_date": "2023-09-01",
  "classes": [
    {
      "class_id": "UUID",
      "is_main_teacher": true
    },
    {
      "class_id": "UUID",
      "is_main_teacher": false
    }
  ]
}
```

**响应参数**：
```json
{
  "type": "teacher",
  "id": "UUID",
  "name": "李四",
  "gender": 1,
  "birthday": "1990-01-01",
  "phone": "13900139000",
  "email": "lisi@example.com",
  "employee_no": "T20230001",
  "department_id": "UUID",
  "department_name": "语文组",
  "classes": [
    {
      "class_id": "UUID",
      "class_name": "高一(1)班",
      "is_main_teacher": true
    },
    {
      "class_id": "UUID",
      "class_name": "高一(2)班",
      "is_main_teacher": false
    }
  ],
  "title": "高级教师",
  "hire_date": "2023-09-01"
}
```

#### 3.2.3 获取人员详情

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons/:id` | `GET` | 获取指定人员的详细信息 |

**响应参数**：与创建人员的响应参数类似

#### 3.2.4 更新人员信息

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons/:id` | `PUT` | 更新指定人员的信息 |

**请求参数**：与创建人员的请求参数类似，但所有字段都是可选的

**响应参数**：与创建人员的响应参数类似

#### 3.2.5 删除人员

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons/:id` | `DELETE` | 删除指定人员 |

**响应**：无内容，状态码 204

### 3.3 班级管理接口

#### 3.3.1 获取班级列表

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/classes` | `GET` | 获取班级列表，支持分页和筛选 |

**查询参数**：
- `page`：页码，默认1
- `limit`：每页数量，默认20
- `search`：搜索关键词
- `grade`：年级

**响应参数**：
```json
{
  "items": [
    {
      "id": "UUID",
      "name": "高一(1)班",
      "grade": 1,
      "teacher_id": "UUID",
      "teacher_name": "李四",
      "academic_year": "2023-2024",
      "created_at": "2023-08-01T00:00:00Z"
    }
  ],
  "total": 10,
  "page": 1,
  "limit": 20
}
```

#### 3.3.2 获取班级学生列表

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/classes/:id/students` | `GET` | 获取指定班级的学生列表 |

**响应参数**：
```json
[
  {
    "type": "student",
    "id": "UUID",
    "name": "张三",
    "gender": 1,
    "birthday": "2005-01-01",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "student_no": "20230001",
    "class_id": "UUID",
    "class_name": null,
    "enrollment_date": "2023-09-01",
    "status": "enrolled"
  }
]
```

#### 3.3.3 获取班级老师列表

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/classes/:id/teachers` | `GET` | 获取指定班级的老师列表 |

**响应参数**：
```json
[
  {
    "type": "teacher",
    "id": "UUID",
    "name": "李四",
    "gender": 1,
    "birthday": "1990-01-01",
    "phone": "13900139000",
    "email": "lisi@example.com",
    "employee_no": "T20230001",
    "department_id": "UUID",
    "department_name": null,
    "classes": [],
    "title": "高级教师",
    "hire_date": "2023-09-01"
  }
]
```

### 3.4 权限管理接口

#### 3.4.1 获取老师被分配的班级列表

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/permission/teacher/classes` | `GET` | 获取指定老师被分配的班级列表 |

**查询参数**：
- `teacher_id`：老师的人员ID

**响应参数**：
```json
[
  {
    "id": "UUID",
    "name": "高一(1)班",
    "grade": 1,
    "academic_year": "2023-2024",
    "is_main_teacher": true
  }
]
```

## 4. 权限控制

### 4.1 接口权限

| 接口类型 | 权限要求 |
|---------|----------|
| 公开接口 | 无需认证 |
| 编辑接口 | 需要认证，且只有管理员和班主任可以操作 |

### 4.2 操作权限

| 操作 | 权限要求 |
|------|----------|
| 查看人员信息 | 所有用户 |
| 编辑学生信息 | 管理员、学生所在班级的班主任 |
| 编辑教师信息 | 管理员、教师所在部门的负责人 |
| 编辑家长信息 | 管理员、关联学生所在班级的班主任 |

## 5. 前端接入说明

### 5.1 认证流程

1. 前端通过 `/api/auth/login` 接口登录，获取JWT令牌
2. 将令牌存储在本地存储中
3. 后续的请求在请求头中添加 `Authorization: Bearer <token>`

### 5.2 班级切换流程

1. 前端显示班级列表
2. 用户选择一个班级
3. 前端通过 `/api/classes/:id/students` 接口获取该班级的学生列表
4. 前端通过 `/api/classes/:id/teachers` 接口获取该班级的老师列表
5. 显示班级详情和相关人员信息

### 5.3 老师班级关联管理

1. 前端在创建或编辑老师信息时，提供多个班级的选择界面
2. 用户可以选择多个班级，并设置是否为主班主任
3. 前端将选择的班级信息通过 `classes` 字段传递给后端
4. 后端保存老师与班级的关联关系

## 6. 示例代码

### 6.1 登录示例

```javascript
// 登录获取令牌
async function login() {
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      username: 'admin',
      password: 'admin123'
    })
  });
  
  const data = await response.json();
  localStorage.setItem('token', data.token);
  return data;
}
```

### 6.2 获取班级学生列表示例

```javascript
// 获取班级学生列表
async function getClassStudents(classId) {
  const token = localStorage.getItem('token');
  const response = await fetch(`/api/classes/${classId}/students`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  return await response.json();
}
```

### 6.3 创建老师示例

```javascript
// 创建老师
async function createTeacher(teacherData) {
  const token = localStorage.getItem('token');
  const response = await fetch('/api/persons', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(teacherData)
  });
  
  return await response.json();
}
```

## 7. 注意事项

1. 所有API接口都遵循RESTful设计原则
2. 所有编辑操作都需要认证令牌
3. 老师与班级的关联关系是多对多的，一个老师可以关联多个班级
4. 班级的 `teacher_id` 字段用于标识班主任，与 `teacher_class` 表中的 `is_main_teacher` 字段对应
5. 前端在切换班级时，应该重新请求对应班级的学生和老师列表

## 8. 后续规划

1. 添加批量导入导出功能
2. 实现更细粒度的权限控制
3. 增加人员信息的历史记录
4. 添加数据统计和分析功能