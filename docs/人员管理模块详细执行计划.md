# 人员管理模块详细执行计划

## 项目概述
人员管理模块是学校管理系统的核心基础模块，负责维护所有人员信息（学生、教职工、家长）以及相关的班级和部门组织。本模块为考勤、评分、通知等其他模块提供人员数据支持。

**开发周期**：预计2-3周（分阶段实施）
**技术栈**：
- 后端：Rust + Axum + SQLx + PostgreSQL
- 前端：Vue 3 + TypeScript + Vite + Pinia + Element Plus

---

## 一、当前状态分析（已完成）

### 1.1 代码库结构
```
x:\works\code\ccccc\
├── backend\                    # 后端Rust项目
│   ├── src\
│   │   ├── api\               # API处理层
│   │   │   ├── person.rs      # 人员API（现有，需改造）
│   │   │   └── routes.rs      # 路由配置
│   │   ├── core\              # 核心模块
│   │   ├── models\            # 数据模型
│   │   │   ├── person.rs      # 人员模型（已更新）
│   │   │   ├── class.rs       # 班级模型（已创建）
│   │   │   ├── department.rs  # 部门模型（已创建）
│   │   │   └── mod.rs         # 模块导出（已更新）
│   │   └── main.rs
│   ├── migrations\            # 数据库迁移
│   │   └── 001_create_persons_tables.sql  # 已创建
│   └── Cargo.toml
└── frontend\                  # 前端Vue项目
    ├── src\
    │   ├── views\
    │   │   └── PersonView.vue  # 人员管理页面（现有，需改造）
    │   ├── router\
    │   └── main.ts
    └── package.json
```

### 1.2 数据库迁移文件（已创建）
**文件路径**：`backend/migrations/001_create_persons_tables.sql`
**内容概要**：
- 创建7张核心表：persons、students、teachers、parents、classes、departments、student_parent
- 建立完整的外键约束关系
- 创建索引优化查询性能
- 添加自动更新触发器

### 1.3 数据模型（已更新/创建）
| 模型文件 | 主要结构体 | 状态 |
|----------|------------|------|
| `models/person.rs` | `Person`, `PersonCreate`, `PersonUpdate`, `PersonResponse`（枚举） | 已更新 |
| `models/class.rs` | `Class`, `ClassCreate`, `ClassUpdate`, `ClassResponse` | 已创建 |
| `models/department.rs` | `Department`, `DepartmentCreate`, `DepartmentUpdate`, `DepartmentResponse` | 已创建 |

---

## 二、开发阶段划分

### 第一阶段：后端核心API（预计3-4天）
#### 目标：实现人员、班级、部门的基本CRUD和搜索功能

#### 2.1 人员管理API改造 (`backend/src/api/person.rs`)
**当前状态**：使用模拟数据，需改造为真实数据库操作

**具体任务**：
1. **移除模拟数据**：删除现有的模拟数据返回逻辑
2. **实现数据库查询函数**：
   ```rust
   // 查询人员列表（支持分页、搜索、过滤）
   pub async fn list_persons(
       pool: &sqlx::PgPool,
       person_type: Option<&str>,
       search: Option<&str>,
       class_id: Option<Uuid>,
       department_id: Option<Uuid>,
       page: i64,
       limit: i64,
   ) -> Result<(Vec<PersonResponse>, i64), AppError>
   
   // 获取单个人员详情
   pub async fn get_person(pool: &sqlx::PgPool, id: Uuid) -> Result<PersonResponse, AppError>
   
   // 创建人员（事务处理）
   pub async fn create_person(pool: &sqlx::PgPool, payload: PersonCreate) -> Result<PersonResponse, AppError>
   
   // 更新人员
   pub async fn update_person(pool: &sqlx::PgPool, id: Uuid, payload: PersonUpdate) -> Result<PersonResponse, AppError>
   
   // 删除人员
   pub async fn delete_person(pool: &sqlx::PgPool, id: Uuid) -> Result<(), AppError>
   ```

3. **实现复杂查询逻辑**：
   - 多表连接查询（persons + students/teachers/parents + classes/departments）
   - 动态条件构建（根据过滤参数生成SQL）
   - 分页处理（count查询 + 数据查询）

4. **错误处理优化**：
   - 使用现有的`AppError`枚举
   - 添加人员特有的错误类型（如学号重复、班级不存在等）

#### 2.2 班级管理API (`backend/src/api/class.rs`)
**新文件创建**：
```rust
// 班级列表查询
pub async fn list_classes(
    pool: &sqlx::PgPool,
    search: Option<&str>,
    grade: Option<i16>,
    page: i64,
    limit: i64,
) -> Result<(Vec<ClassResponse>, i64), AppError>

// 获取班级详情（包含班主任信息）
pub async fn get_class(pool: &sqlx::PgPool, id: Uuid) -> Result<ClassResponse, AppError>

// 创建班级
pub async fn create_class(pool: &sqlx::PgPool, payload: ClassCreate) -> Result<ClassResponse, AppError>

// 更新班级
pub async fn update_class(pool: &sqlx::PgPool, id: Uuid, payload: ClassUpdate) -> Result<ClassResponse, AppError>

// 删除班级
pub async fn delete_class(pool: &sqlx::PgPool, id: Uuid) -> Result<(), AppError>
```

#### 2.3 部门管理API (`backend/src/api/department.rs`)
**新文件创建**：
- 类似班级API，但需处理树形结构
- 支持部门层级查询

#### 2.4 路由配置更新 (`backend/src/api/routes.rs`)
**新增路由**：
```rust
// 班级管理
.route("/api/classes", get(class::list))
.route("/api/classes", post(class::create))
.route("/api/classes/:id", get(class::get))
.route("/api/classes/:id", put(class::update))
.route("/api/classes/:id", delete(class::delete))

// 部门管理
.route("/api/departments", get(department::list))
.route("/api/departments", post(department::create))
.route("/api/departments/:id", get(department::get))
.route("/api/departments/:id", put(department::update))
.route("/api/departments/:id", delete(department::delete))
```

#### 2.5 模块导出更新 (`backend/src/api/mod.rs`)
**新增导出**：
```rust
pub mod person;
pub mod class;
pub mod department;
// ... 现有其他模块
```

### 第二阶段：前端页面实现（预计3-4天）
#### 目标：改造现有页面，实现完整的人员管理界面

#### 2.6 人员列表页增强 (`frontend/src/views/PersonView.vue`)
**改造内容**：
1. **API连接**：将模拟数据替换为真实API调用
2. **搜索功能增强**：
   ```typescript
   interface PersonQuery {
     page: number;
     limit: number;
     type?: 'student' | 'teacher' | 'parent';
     q?: string; // 搜索关键字
     class_id?: string;
     department_id?: string;
   }
   ```
3. **组件拆分**：
   - 将搜索表单提取为独立组件 `SearchForm.vue`
   - 将操作按钮组提取为独立组件 `ActionButtons.vue`

4. **状态管理集成**：
   ```typescript
   // stores/person.ts
   export const usePersonStore = defineStore('person', () => {
     const persons = ref<PersonResponse[]>([]);
     const total = ref(0);
     const loading = ref(false);
     
     async function fetchPersons(query: PersonQuery) {
       loading.value = true;
       try {
         const res = await listPersons(query);
         persons.value = res.items;
         total.value = res.total;
       } finally {
         loading.value = false;
       }
     }
     // ... 其他操作
   });
   ```

#### 2.7 人员表单组件 (`frontend/src/components/PersonForm.vue`)
**新文件创建**：
```vue
<template>
  <el-form :model="form" :rules="rules" ref="formRef">
    <!-- 基础信息 -->
    <el-form-item label="姓名" prop="name">
      <el-input v-model="form.name" />
    </el-form-item>
    
    <el-form-item label="类型" prop="type">
      <el-select v-model="form.type" @change="handleTypeChange">
        <el-option label="学生" value="student" />
        <el-option label="教职工" value="teacher" />
        <el-option label="家长" value="parent" />
      </el-select>
    </el-form-item>
    
    <!-- 动态字段 -->
    <template v-if="form.type === 'student'">
      <el-form-item label="学号" prop="student_no">
        <el-input v-model="form.student_no" />
      </el-form-item>
      <el-form-item label="班级" prop="class_id">
        <el-select v-model="form.class_id" :loading="classesLoading">
          <el-option v-for="cls in classes" :key="cls.id" :label="cls.name" :value="cls.id" />
        </el-select>
      </el-form-item>
    </template>
    
    <!-- 其他类型字段... -->
  </el-form>
</template>
```

#### 2.8 班级管理页面 (`frontend/src/views/ClassView.vue`)
**新文件创建**：
- 班级列表、创建、编辑、删除功能
- 选择班主任（从教师列表中选取）
- 年级筛选和搜索

#### 2.9 部门管理页面 (`frontend/src/views/DepartmentView.vue`)
**新文件创建**：
- 部门树形结构展示（使用Element Plus的Tree组件）
- 支持部门层级调整
- 部门人员统计

#### 2.10 API封装文件
**新文件创建**：
1. `frontend/src/api/person.ts`：人员相关API
2. `frontend/src/api/class.ts`：班级相关API
3. `frontend/src/api/department.ts`：部门相关API

**示例**（person.ts）：
```typescript
import request from '@/utils/request';
import type { PersonResponse, PersonQuery, PersonCreate } from '@/types/person';

export function listPersons(params: PersonQuery) {
  return request.get<{
    items: PersonResponse[];
    total: number;
    page: number;
    limit: number;
  }>('/persons', { params });
}

export function getPerson(id: string) {
  return request.get<PersonResponse>(`/persons/${id}`);
}

export function createPerson(data: PersonCreate) {
  return request.post<PersonResponse>('/persons', data);
}

export function updatePerson(id: string, data: Partial<PersonCreate>) {
  return request.put<PersonResponse>(`/persons/${id}`, data);
}

export function deletePerson(id: string) {
  return request.delete(`/persons/${id}`);
}
```

#### 2.11 类型定义文件
**新文件创建**：`frontend/src/types/person.ts`
```typescript
export interface PersonBase {
  id: string;
  name: string;
  gender: number;
  birthday?: string;
  phone?: string;
  email?: string;
  type: 'student' | 'teacher' | 'parent';
}

export interface StudentResponse extends PersonBase {
  type: 'student';
  student_no: string;
  class_id?: string;
  class_name?: string;
  enrollment_date?: string;
  status: string;
}

export interface TeacherResponse extends PersonBase {
  type: 'teacher';
  employee_no: string;
  department_id?: string;
  department_name?: string;
  title?: string;
  hire_date?: string;
}

export interface ParentResponse extends PersonBase {
  type: 'parent';
  wechat_openid?: string;
  occupation?: string;
}

export type PersonResponse = StudentResponse | TeacherResponse | ParentResponse;

export interface PersonQuery {
  page: number;
  limit: number;
  type?: 'student' | 'teacher' | 'parent';
  q?: string;
  class_id?: string;
  department_id?: string;
}
```

### 第三阶段：高级功能实现（预计2-3天）
#### 目标：实现批量操作和搜索优化

#### 3.1 导入导出功能
**后端实现**：
1. **导入接口** (`POST /api/persons/import`)：
   - 使用`calamine`库解析Excel文件
   - 逐行验证数据格式
   - 批量插入数据库（使用事务）
   - 返回导入结果统计

2. **导出接口** (`GET /api/persons/export`)：
   - 使用`rust_xlsxwriter`库生成Excel
   - 支持查询参数过滤导出数据
   - 返回文件流响应

**前端实现**：
1. **上传组件**：支持Excel文件上传，显示进度
2. **模板下载**：提供标准Excel模板
3. **结果展示**：显示导入成功/失败详情

#### 3.2 搜索优化
**数据库优化**：
1. 启用PostgreSQL的`pg_trgm`扩展
2. 创建GIN索引：`CREATE INDEX idx_persons_name_trgm ON persons USING gin (name gin_trgm_ops)`
3. 使用相似度搜索：`WHERE name % $1`

**前端优化**：
1. 搜索输入防抖（500ms）
2. 搜索建议（可选）

#### 3.3 数据验证
**后端验证**：
1. 学号/工号唯一性检查
2. 班级/部门存在性验证
3. 必填字段验证
4. 数据格式验证（邮箱、电话等）

**前端验证**：
1. 表单实时验证
2. 提交前的数据校验

---

## 三、测试策略

### 3.1 后端测试
**单元测试**：
- 每个API处理函数的输入输出测试
- 数据库查询函数的测试（使用测试数据库）

**集成测试**：
- API端点测试（使用`reqwest`）
- 数据库迁移测试
- 事务处理测试

### 3.2 前端测试
**组件测试**：
- 表单组件渲染和交互测试
- 列表组件分页和搜索测试

**E2E测试**：
- 完整的人员管理流程测试
- 导入导出功能测试

### 3.3 测试数据准备
1. 开发环境测试数据脚本
2. 性能测试大数据集

---

## 四、部署考虑

### 4.1 数据库部署
1. **迁移执行**：应用启动时自动执行数据库迁移
2. **索引优化**：根据查询模式优化索引
3. **数据备份**：定期备份人员数据

### 4.2 应用部署
1. **环境配置**：数据库连接、文件上传路径等配置
2. **性能优化**：连接池配置、缓存策略
3. **监控指标**：API响应时间、错误率监控

### 4.3 前端部署
1. **构建优化**：代码分割、资源压缩
2. **CDN部署**：静态资源加速
3. **浏览器兼容性**：支持主流浏览器

---

## 五、开发注意事项

### 5.1 代码规范
1. **Rust代码**：遵循现有的代码风格，使用`cargo fmt`和`cargo clippy`
2. **TypeScript代码**：使用ESLint和Prettier规范
3. **提交规范**：使用语义化提交消息

### 5.2 安全性考虑
1. **输入验证**：所有用户输入必须验证
2. **SQL注入防护**：使用SQLx的参数化查询
3. **文件上传安全**：限制文件类型和大小

### 5.3 性能优化
1. **数据库查询**：使用合适的索引，避免N+1查询
2. **前端加载**：懒加载、虚拟滚动
3. **缓存策略**：合理使用浏览器缓存和CDN缓存

---

## 六、风险管理

### 6.1 技术风险
- **数据库设计缺陷**：已通过详细设计评审降低风险
- **性能瓶颈**：通过索引优化和查询优化缓解
- **兼容性问题**：通过测试覆盖不同浏览器和环境

### 6.2 进度风险
- **功能范围蔓延**：严格按照本计划执行，变更需评审
- **技术难点**：提前调研关键技术点（如Excel处理）
- **依赖风险**：确保第三方库的稳定性和兼容性

### 6.3 质量风险
- **测试覆盖率**：确保关键功能有足够的测试覆盖
- **代码审查**：所有代码必须经过审查才能合并
- **持续集成**：自动化构建和测试流程

---

## 七、验收标准

### 7.1 功能验收
- [ ] 人员管理：完整的CRUD操作，支持三种类型
- [ ] 班级管理：班级的创建、编辑、删除，分配班主任
- [ ] 部门管理：部门树形结构管理
- [ ] 搜索功能：多条件组合搜索，模糊匹配
- [ ] 导入导出：Excel批量导入导出功能
- [ ] 数据验证：前后端完整的数据验证

### 7.2 性能验收
- [ ] 列表加载：1000条数据加载时间<2秒
- [ ] 搜索响应：搜索结果返回时间<1秒
- [ ] 批量导入：1000条数据导入时间<30秒

### 7.3 质量验收
- [ ] 代码覆盖率：关键功能测试覆盖率>80%
- [ ] 无严重bug：上线前无P0/P1级别bug
- [ ] 文档完整：API文档、使用文档齐全

---

## 八、后续优化建议

### 8.1 短期优化（上线后1个月内）
1. **搜索优化**：实现全文搜索，支持拼音搜索
2. **权限控制**：集成RBAC权限系统
3. **数据统计**：人员数据统计报表

### 8.2 中期优化（3-6个月）
1. **移动端适配**：开发移动端界面
2. **实时通知**：人员变动实时通知
3. **数据同步**：与其他系统数据同步

### 8.3 长期规划（6个月以上）
1. **人工智能**：智能分班、人员推荐
2. **大数据分析**：人员行为分析预测
3. **开放平台**：提供API给第三方系统

---

## 附录

### A. 相关文件路径
1. 数据库迁移文件：`backend/migrations/001_create_persons_tables.sql`
2. 后端模型文件：`backend/src/models/person.rs`, `class.rs`, `department.rs`
3. 后端API文件：`backend/src/api/person.rs`, `class.rs`, `department.rs`
4. 前端页面文件：`frontend/src/views/PersonView.vue`, `ClassView.vue`, `DepartmentView.vue`
5. 前端组件文件：`frontend/src/components/PersonForm.vue`
6. 前端类型定义：`frontend/src/types/person.ts`
7. 前端API封装：`frontend/src/api/person.ts`, `class.ts`, `department.ts`

### B. 技术参考资料
1. Axum官方文档：https://docs.rs/axum
2. SQLx文档：https://docs.rs/sqlx
3. Vue 3文档：https://vuejs.org
4. Element Plus文档：https://element-plus.org

### C. 开发工具推荐
1. **数据库工具**：pgAdmin 4（已包含在support目录）
2. **API测试**：Postman或Insomnia
3. **前端调试**：Vue DevTools
4. **代码编辑**：VS Code + Rust Analyzer + Volar

---

**文档版本**：1.0  
**最后更新**：2026-02-24  
**负责人**：开发团队  
**状态**：待执行