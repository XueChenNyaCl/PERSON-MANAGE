# 数据库信息文档

## 1. 数据库连接配置

### 1.1 连接方式
- 使用 `sqlx` 库进行异步数据库操作
- 数据库连接池配置在 `backend/src/core/db.rs` 中
- 最大连接数：10

### 1.2 环境配置
在 `backend/.env` 文件中配置数据库连接信息：

```env
# 数据库连接字符串
DATABASE_URL=postgres://username:password@localhost:5432/database_name
```

## 2. 数据库表结构

### 2.1 人员表 (`person`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 人员唯一标识 |
| `name` | `VARCHAR` | `NOT NULL` | 姓名 |
| `gender` | `SMALLINT` | `NOT NULL` | 性别 (0:未知, 1:男, 2:女) |
| `birthday` | `DATE` | `NULL` | 出生日期 |
| `phone` | `VARCHAR` | `NULL` | 电话号码 |
| `email` | `VARCHAR` | `NULL` | 邮箱地址 |
| `type` | `VARCHAR` | `NOT NULL` | 人员类型 ('student', 'teacher', 'parent') |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `NOT NULL` | 更新时间 |

### 2.2 学生表 (`student`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `person_id` | `UUID` | `PRIMARY KEY, REFERENCES person(id)` | 关联人员ID |
| `student_no` | `VARCHAR` | `NOT NULL` | 学号 |
| `class_id` | `UUID` | `NULL, REFERENCES class(id)` | 关联班级ID |
| `enrollment_date` | `DATE` | `NULL` | 入学日期 |
| `status` | `VARCHAR` | `NOT NULL` | 学生状态 |

### 2.3 教师表 (`teacher`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `person_id` | `UUID` | `PRIMARY KEY, REFERENCES person(id)` | 关联人员ID |
| `employee_no` | `VARCHAR` | `NOT NULL` | 工号 |
| `department_id` | `UUID` | `NULL, REFERENCES department(id)` | 关联部门ID |
| `class_id` | `UUID` | `NULL, REFERENCES class(id)` | 关联班级ID (作为班主任) |
| `title` | `VARCHAR` | `NULL` | 职称 |
| `hire_date` | `DATE` | `NULL` | 入职日期 |

### 2.4 家长表 (`parent`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `person_id` | `UUID` | `PRIMARY KEY, REFERENCES person(id)` | 关联人员ID |
| `wechat_openid` | `VARCHAR` | `NULL` | 微信OpenID |
| `occupation` | `VARCHAR` | `NULL` | 职业 |

### 2.5 班级表 (`class`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 班级唯一标识 |
| `name` | `VARCHAR` | `NOT NULL` | 班级名称 |
| `grade` | `SMALLINT` | `NOT NULL` | 年级 |
| `teacher_id` | `UUID` | `NULL, REFERENCES person(id)` | 班主任ID |
| `academic_year` | `VARCHAR` | `NOT NULL` | 学年 (如 "2025-2026") |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |

### 2.6 部门表 (`department`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 部门唯一标识 |
| `name` | `VARCHAR` | `NOT NULL` | 部门名称 |
| `parent_id` | `UUID` | `NULL, REFERENCES department(id)` | 上级部门ID |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |

### 2.7 考勤表 (`attendance`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 考勤记录唯一标识 |
| `person_id` | `UUID` | `NOT NULL, REFERENCES person(id)` | 关联人员ID |
| `date` | `DATE` | `NOT NULL` | 考勤日期 |
| `status` | `VARCHAR` | `NOT NULL` | 考勤状态 (present, absent, late, excused) |
| `time` | `TIME` | `NULL` | 考勤时间 |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `NOT NULL` | 更新时间 |

### 2.8 成绩表 (`score`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 成绩记录唯一标识 |
| `person_id` | `UUID` | `NOT NULL, REFERENCES person(id)` | 关联人员ID |
| `group_id` | `UUID` | `NULL` | 关联组ID (如班级、宿舍) |
| `score_type` | `VARCHAR` | `NOT NULL` | 分数类型 (personal, group, class, dormitory) |
| `value` | `INTEGER` | `NOT NULL` | 分数值 |
| `reason` | `VARCHAR` | `NOT NULL` | 评分原因 |
| `event_id` | `UUID` | `NULL` | 关联事件ID |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `NOT NULL` | 更新时间 |

### 2.9 通知表 (`notice`)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 通知唯一标识 |
| `title` | `VARCHAR` | `NOT NULL` | 通知标题 |
| `content` | `TEXT` | `NOT NULL` | 通知内容 |
| `author_id` | `UUID` | `NOT NULL, REFERENCES person(id)` | 作者ID |
| `target_type` | `VARCHAR` | `NOT NULL` | 目标类型 (school, class, department) |
| `target_id` | `UUID` | `NULL` | 目标ID (如班级ID、部门ID) |
| `attachments` | `JSONB` | `NULL` | 附件列表 |
| `created_at` | `TIMESTAMP` | `NOT NULL` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `NOT NULL` | 更新时间 |

## 3. API接口说明

### 3.1 数据库状态检查

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/db/status` | `GET` | 检查数据库连接状态 |

### 3.2 人员管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/persons` | `GET` | 获取人员列表 |
| `/api/persons` | `POST` | 创建新人员 |
| `/api/persons/:id` | `GET` | 获取指定人员详情 |
| `/api/persons/:id` | `PUT` | 更新指定人员信息 |
| `/api/persons/:id` | `DELETE` | 删除指定人员 |

### 3.3 班级管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/classes` | `GET` | 获取班级列表 |
| `/api/classes` | `POST` | 创建新班级 |
| `/api/classes/:id` | `GET` | 获取指定班级详情 |
| `/api/classes/:id` | `PUT` | 更新指定班级信息 |
| `/api/classes/:id` | `DELETE` | 删除指定班级 |

### 3.4 部门管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/departments` | `GET` | 获取部门列表 |
| `/api/departments` | `POST` | 创建新部门 |
| `/api/departments/:id` | `GET` | 获取指定部门详情 |
| `/api/departments/:id` | `PUT` | 更新指定部门信息 |
| `/api/departments/:id` | `DELETE` | 删除指定部门 |

### 3.5 考勤管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/attendance` | `GET` | 获取考勤记录列表 |
| `/api/attendance` | `POST` | 创建新考勤记录 |

### 3.6 评分管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/score` | `GET` | 获取评分记录列表 |
| `/api/score` | `POST` | 创建新评分记录 |

### 3.7 通知管理接口

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/notice` | `GET` | 获取通知列表 |
| `/api/notice` | `POST` | 创建新通知 |

## 4. 表之间的关系

### 4.1 主要关系图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   person    │◄──────┤   student   │◄──────┤    class    │
└─────────────┘       └─────────────┘       └─────────────┘
       ▲                      ▲                   │
       │                      │                   │
       │                      │                   │
       ├──────────────────────┘                   │
       │                                          │
       │                                          │
       ▼                                          │
┌─────────────┐       ┌─────────────┐             │
│   teacher   │◄──────┤ department  │             │
└─────────────┘       └─────────────┘             │
       ▲                                          │
       │                                          │
       │                                          │
       ├──────────────────────────────────────────┘
       │
       │
       ▼
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   parent    │       │ attendance  │       │    score    │
└─────────────┘       └─────────────┘       └─────────────┘
       ▲                      ▲                   ▲
       │                      │                   │
       │                      │                   │
       └──────────────────────┼───────────────────┘
                              │
                              │
                              ▼
                      ┌─────────────┐
                      │   notice    │
                      └─────────────┘
```

### 4.2 详细关系说明

1. **人员与子类型关系**：
   - 一个 `person` 可以是 `student`、`teacher` 或 `parent` 中的一种
   - 通过 `person.type` 字段区分人员类型

2. **班级与学生关系**：
   - 一个班级可以有多个学生（一对多）
   - 一个学生属于一个班级（多对一）

3. **班级与教师关系**：
   - 一个班级有一个班主任（一对一）
   - 一个教师可以担任多个班级的班主任（一对多）

4. **教师与部门关系**：
   - 一个教师属于一个部门（多对一）
   - 一个部门可以有多个教师（一对多）

5. **部门层级关系**：
   - 部门可以有父部门（自引用关系）

6. **人员与考勤关系**：
   - 一个人员可以有多条考勤记录（一对多）

7. **人员与成绩关系**：
   - 一个人员可以有多条成绩记录（一对多）

8. **通知关系**：
   - 通知可以针对学校、班级或部门
   - 通知有一个作者（person）

## 5. 数据模型定义位置

所有数据模型定义位于 `backend/src/models/` 目录下：

| 模型文件 | 对应表 | 描述 |
|---------|-------|------|
| `person.rs` | `person`, `student`, `teacher`, `parent` | 人员相关模型 |
| `class.rs` | `class` | 班级相关模型 |
| `department.rs` | `department` | 部门相关模型 |
| `attendance.rs` | `attendance` | 考勤相关模型 |
| `score.rs` | `score` | 成绩相关模型 |
| `notice.rs` | `notice` | 通知相关模型 |
| `user.rs` | `user` | 用户相关模型 |

## 6. 数据库迁移

项目使用 `sqlx` 的迁移功能进行数据库结构管理。迁移文件位于 `backend/migrations/` 目录下。

### 6.1 执行迁移

```bash
# 执行所有未应用的迁移
cargo sqlx migrate run

# 回滚最后一次迁移
cargo sqlx migrate revert
```

## 7. 注意事项

1. **UUID使用**：所有表的主键均使用UUID类型，确保全局唯一性
2. **时间戳**：所有表都包含 `created_at` 和 `updated_at` 字段，记录数据的创建和更新时间
3. **软删除**：目前未实现软删除功能，删除操作会直接从数据库中移除记录
4. **数据验证**：API接口会对输入数据进行验证，确保数据的完整性和合法性
5. **权限控制**：API接口的权限控制逻辑在各自的处理函数中实现

## 8. 常见问题排查

### 8.1 数据库连接失败

1. 检查 `.env` 文件中的数据库连接字符串是否正确
2. 确认 PostgreSQL 服务是否正在运行
3. 验证数据库用户是否存在且有正确的权限
4. 检查网络连接是否正常

### 8.2 数据操作失败

1. 检查输入数据是否符合验证规则
2. 确认是否存在外键约束冲突
3. 验证用户权限是否足够
4. 查看服务器日志获取详细错误信息

### 8.3 性能问题

1. 考虑添加适当的索引
2. 优化SQL查询语句
3. 检查数据库连接池配置
4. 考虑使用缓存减少数据库查询

---

本文档由系统自动生成，基于当前代码库的实际实现。如有变更，请及时更新文档。