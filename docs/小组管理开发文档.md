# 小组管理开发文档

## 1. 功能概述

本功能实现班级内的小组管理，包括：
- 班级内创建、编辑、删除小组
- 小组成员管理（添加/移除成员）
- 小组积分管理（加分/减分）
- 小组权限控制（仅班主任可管理小组）

## 2. 数据库设计

### 2.1 表结构设计

#### 2.1.1 `groups` 表

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 小组ID |
| `class_id` | `UUID` | `REFERENCES classes(id)` | 所属班级ID |
| `name` | `VARCHAR(50)` | `NOT NULL` | 小组名称 |
| `description` | `TEXT` | | 小组描述 |
| `score` | `INTEGER` | `DEFAULT 0` | 小组积分 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

#### 2.1.2 `group_members` 表

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 成员ID |
| `group_id` | `UUID` | `REFERENCES groups(id)` | 小组ID |
| `person_id` | `UUID` | `REFERENCES persons(id)` | 成员ID（学生） |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 2.1.3 `group_score_records` 表

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `UUID` | `PRIMARY KEY` | 记录ID |
| `group_id` | `UUID` | `REFERENCES groups(id)` | 小组ID |
| `score_change` | `INTEGER` | `NOT NULL` | 积分变化（正数为加，负数为减） |
| `reason` | `TEXT` | `NOT NULL` | 积分变化原因 |
| `created_by` | `UUID` | `REFERENCES persons(id)` | 操作人ID |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 2.2 数据库迁移脚本

创建 `006_create_group_tables.sql` 文件：

```sql
-- 创建小组表
CREATE TABLE IF NOT EXISTS groups (
    id UUID PRIMARY KEY,
    class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    score INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建小组成员表
CREATE TABLE IF NOT EXISTS group_members (
    id UUID PRIMARY KEY,
    group_id UUID REFERENCES groups(id) ON DELETE CASCADE,
    person_id UUID REFERENCES persons(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(group_id, person_id)
);

-- 创建小组积分记录表
CREATE TABLE IF NOT EXISTS group_score_records (
    id UUID PRIMARY KEY,
    group_id UUID REFERENCES groups(id) ON DELETE CASCADE,
    score_change INTEGER NOT NULL,
    reason TEXT NOT NULL,
    created_by UUID REFERENCES persons(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_groups_class_id ON groups(class_id);
CREATE INDEX IF NOT EXISTS idx_group_members_group_id ON group_members(group_id);
CREATE INDEX IF NOT EXISTS idx_group_members_person_id ON group_members(person_id);
CREATE INDEX IF NOT EXISTS idx_group_score_records_group_id ON group_score_records(group_id);
```

## 3. 后端实现

### 3.1 模型定义

创建 `backend/src/models/group.rs` 文件：

```rust
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

#[derive(Debug, Deserialize, Serialize, sqlx::FromRow)]
pub struct Group {
    pub id: Uuid,
    pub class_id: Uuid,
    pub name: String,
    pub description: Option<String>,
    pub score: i32,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct GroupCreate {
    pub class_id: String,
    pub name: String,
    pub description: Option<String>,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct GroupUpdate {
    pub name: Option<String>,
    pub description: Option<String>,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct GroupResponse {
    pub id: Uuid,
    pub class_id: Uuid,
    pub class_name: Option<String>,
    pub name: String,
    pub description: Option<String>,
    pub score: i32,
    pub member_count: i64,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize, Serialize, sqlx::FromRow)]
pub struct GroupMember {
    pub id: Uuid,
    pub group_id: Uuid,
    pub person_id: Uuid,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct GroupMemberAdd {
    pub person_id: String,
}

#[derive(Debug, Deserialize, Serialize, sqlx::FromRow)]
pub struct GroupScoreRecord {
    pub id: Uuid,
    pub group_id: Uuid,
    pub score_change: i32,
    pub reason: String,
    pub created_by: Uuid,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct GroupScoreChange {
    pub score_change: i32,
    pub reason: String,
}
```

### 3.2 API接口实现

创建 `backend/src/api/group.rs` 文件：

```rust
use axum::{
    extract::{Extension, Path, State},
    http::StatusCode,
    Json,
};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

use crate::api::routes::AppState;
use crate::core::auth::Claims;
use crate::core::error::AppError;
use crate::core::permission::PermissionManager;
use crate::models::group::*;

// 小组列表
pub async fn list(
    State(state): State<AppState>,
    Path(class_id): Path<Uuid>,
) -> Result<Json<Vec<GroupResponse>>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let groups = list_groups(&pool, class_id).await?;
    Ok(Json(groups))
}

// 创建小组
pub async fn create(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Json(payload): Json<GroupCreate>,
) -> Result<Json<GroupResponse>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以创建小组
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.create").await?;
    
    // 验证用户是否是该班级的班主任
    let class_id = Uuid::parse_str(&payload.class_id).map_err(|_| AppError::Validation("无效的班级ID".to_string()))?;
    validate_class_teacher(&pool, class_id, user_id).await?;
    
    let group = create_group(&pool, payload).await?;
    Ok(Json(group))
}

// 获取小组详情
pub async fn get(
    State(state): State<AppState>,
    Path(id): Path<Uuid>,
) -> Result<Json<GroupResponse>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let group = get_group(&pool, id).await?;
    Ok(Json(group))
}

// 更新小组
pub async fn update(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Path(id): Path<Uuid>,
    Json(payload): Json<GroupUpdate>,
) -> Result<Json<GroupResponse>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以更新小组
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.update").await?;
    
    // 验证用户是否是该班级的班主任
    let group = sqlx::query!("SELECT class_id FROM groups WHERE id = $1", id)
        .fetch_optional(&pool)
        .await?
        .ok_or(AppError::NotFound)?;
    validate_class_teacher(&pool, group.class_id, user_id).await?;
    
    let updated_group = update_group(&pool, id, payload).await?;
    Ok(Json(updated_group))
}

// 删除小组
pub async fn delete(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Path(id): Path<Uuid>,
) -> Result<StatusCode, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以删除小组
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.delete").await?;
    
    // 验证用户是否是该班级的班主任
    let group = sqlx::query!("SELECT class_id FROM groups WHERE id = $1", id)
        .fetch_optional(&pool)
        .await?
        .ok_or(AppError::NotFound)?;
    validate_class_teacher(&pool, group.class_id, user_id).await?;
    
    delete_group(&pool, id).await?;
    Ok(StatusCode::NO_CONTENT)
}

// 获取小组成员
pub async fn get_members(
    State(state): State<AppState>,
    Path(id): Path<Uuid>,
) -> Result<Json<Vec<PersonResponse>>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let members = get_group_members(&pool, id).await?;
    Ok(Json(members))
}

// 添加成员
pub async fn add_member(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Path(id): Path<Uuid>,
    Json(payload): Json<GroupMemberAdd>,
) -> Result<StatusCode, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以添加成员
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.update.member").await?;
    
    // 验证用户是否是该班级的班主任
    let group = sqlx::query!("SELECT class_id FROM groups WHERE id = $1", id)
        .fetch_optional(&pool)
        .await?
        .ok_or(AppError::NotFound)?;
    validate_class_teacher(&pool, group.class_id, user_id).await?;
    
    add_group_member(&pool, id, &payload.person_id).await?;
    Ok(StatusCode::NO_CONTENT)
}

// 移除成员
pub async fn remove_member(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Path((id, person_id)): Path<(Uuid, Uuid)>,
) -> Result<StatusCode, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以移除成员
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.update.member").await?;
    
    // 验证用户是否是该班级的班主任
    let group = sqlx::query!("SELECT class_id FROM groups WHERE id = $1", id)
        .fetch_optional(&pool)
        .await?
        .ok_or(AppError::NotFound)?;
    validate_class_teacher(&pool, group.class_id, user_id).await?;
    
    remove_group_member(&pool, id, person_id).await?;
    Ok(StatusCode::NO_CONTENT)
}

// 小组加分减分
pub async fn update_score(
    State(state): State<AppState>,
    Extension(claims): Extension<Claims>,
    Path(id): Path<Uuid>,
    Json(payload): Json<GroupScoreChange>,
) -> Result<Json<GroupScoreRecord>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let user_id = Uuid::parse_str(&claims.sub).map_err(|_| AppError::Auth("无效的用户ID".to_string()))?;
    
    // 检查权限：只有班主任可以修改小组积分
    let manager = PermissionManager::new(pool.clone());
    manager.require_permission(user_id, "group.update.score").await?;
    
    // 验证用户是否是该班级的班主任
    let group = sqlx::query!("SELECT class_id FROM groups WHERE id = $1", id)
        .fetch_optional(&pool)
        .await?
        .ok_or(AppError::NotFound)?;
    validate_class_teacher(&pool, group.class_id, user_id).await?;
    
    let record = update_group_score(&pool, id, user_id, payload).await?;
    Ok(Json(record))
}

// 获取小组积分记录
pub async fn get_score_records(
    State(state): State<AppState>,
    Path(id): Path<Uuid>,
) -> Result<Json<Vec<GroupScoreRecord>>, AppError> {
    let pool = state.pool.ok_or_else(|| AppError::Internal)?;
    let records = get_group_score_records(&pool, id).await?;
    Ok(Json(records))
}

// 验证用户是否是班级班主任
async fn validate_class_teacher(pool: &sqlx::PgPool, class_id: Uuid, user_id: Uuid) -> Result<(), AppError> {
    let class = sqlx::query!("SELECT teacher_id FROM classes WHERE id = $1", class_id)
        .fetch_optional(pool)
        .await?
        .ok_or(AppError::NotFound)?;
    
    if class.teacher_id != Some(user_id) {
        return Err(AppError::Auth("只有班主任可以管理小组".to_string()));
    }
    
    Ok(())
}

// 实现具体的数据库操作函数
// ...（具体实现见下方）

use crate::models::person::PersonResponse;

async fn list_groups(pool: &sqlx::PgPool, class_id: Uuid) -> Result<Vec<GroupResponse>, AppError> {
    let rows = sqlx::query!(
        "SELECT g.id, g.class_id, g.name, g.description, g.score, g.created_at, g.updated_at, 
                c.name as class_name,
                COUNT(gm.id) as member_count
         FROM groups g
         LEFT JOIN classes c ON g.class_id = c.id
         LEFT JOIN group_members gm ON g.id = gm.group_id
         WHERE g.class_id = $1
         GROUP BY g.id, c.name
         ORDER BY g.created_at DESC",
        class_id
    )
    .fetch_all(pool)
    .await?;
    
    let groups: Vec<GroupResponse> = rows.into_iter().map(|row| GroupResponse {
        id: row.id,
        class_id: row.class_id,
        class_name: Some(row.class_name),
        name: row.name,
        description: row.description,
        score: row.score,
        member_count: row.member_count,
        created_at: row.created_at,
        updated_at: row.updated_at,
    }).collect();
    
    Ok(groups)
}

async fn create_group(pool: &sqlx::PgPool, payload: GroupCreate) -> Result<GroupResponse, AppError> {
    let class_id = Uuid::parse_str(&payload.class_id).map_err(|_| AppError::Validation("无效的班级ID".to_string()))?;
    let id = Uuid::new_v4();
    
    sqlx::query!(
        "INSERT INTO groups (id, class_id, name, description) 
         VALUES ($1, $2, $3, $4)",
        id, class_id, payload.name, payload.description
    )
    .execute(pool)
    .await?;
    
    get_group(pool, id).await
}

async fn get_group(pool: &sqlx::PgPool, id: Uuid) -> Result<GroupResponse, AppError> {
    let row = sqlx::query!(
        "SELECT g.id, g.class_id, g.name, g.description, g.score, g.created_at, g.updated_at, 
                c.name as class_name,
                COUNT(gm.id) as member_count
         FROM groups g
         LEFT JOIN classes c ON g.class_id = c.id
         LEFT JOIN group_members gm ON g.id = gm.group_id
         WHERE g.id = $1
         GROUP BY g.id, c.name",
        id
    )
    .fetch_optional(pool)
    .await?
    .ok_or(AppError::NotFound)?;
    
    Ok(GroupResponse {
        id: row.id,
        class_id: row.class_id,
        class_name: Some(row.class_name),
        name: row.name,
        description: row.description,
        score: row.score,
        member_count: row.member_count,
        created_at: row.created_at,
        updated_at: row.updated_at,
    })
}

async fn update_group(pool: &sqlx::PgPool, id: Uuid, payload: GroupUpdate) -> Result<GroupResponse, AppError> {
    let mut tx = pool.begin().await?;
    
    if let Some(name) = payload.name {
        sqlx::query!("UPDATE groups SET name = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2", name, id)
            .execute(&mut *tx)
            .await?;
    }
    
    if let Some(description) = payload.description {
        sqlx::query!("UPDATE groups SET description = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2", description, id)
            .execute(&mut *tx)
            .await?;
    }
    
    tx.commit().await?;
    get_group(pool, id).await
}

async fn delete_group(pool: &sqlx::PgPool, id: Uuid) -> Result<(), AppError> {
    let result = sqlx::query!("DELETE FROM groups WHERE id = $1", id)
        .execute(pool)
        .await?;
    
    if result.rows_affected() == 0 {
        return Err(AppError::NotFound);
    }
    
    Ok(())
}

async fn get_group_members(pool: &sqlx::PgPool, group_id: Uuid) -> Result<Vec<PersonResponse>, AppError> {
    let rows = sqlx::query!(
        "SELECT p.id, p.name, p.gender, p.birthday, p.phone, p.email, p.type,
                s.student_no, s.class_id, s.enrollment_date, s.status
         FROM persons p
         JOIN students s ON p.id = s.person_id
         JOIN group_members gm ON p.id = gm.person_id
         WHERE gm.group_id = $1
         ORDER BY p.name",
        group_id
    )
    .fetch_all(pool)
    .await?;
    
    let members: Vec<PersonResponse> = rows.into_iter().map(|row| {
        PersonResponse::Student(crate::models::person::StudentResponse {
            id: row.id,
            name: row.name,
            gender: row.gender,
            birthday: row.birthday,
            phone: row.phone,
            email: row.email,
            student_no: row.student_no,
            class_id: row.class_id,
            class_name: None,
            enrollment_date: row.enrollment_date,
            status: row.status.expect("Student status is required")
        })
    }).collect();
    
    Ok(members)
}

async fn add_group_member(pool: &sqlx::PgPool, group_id: Uuid, person_id_str: &str) -> Result<(), AppError> {
    let person_id = Uuid::parse_str(person_id_str).map_err(|_| AppError::Validation("无效的人员ID".to_string()))?;
    let id = Uuid::new_v4();
    
    sqlx::query!(
        "INSERT INTO group_members (id, group_id, person_id)
         VALUES ($1, $2, $3)
         ON CONFLICT (group_id, person_id) DO NOTHING",
        id, group_id, person_id
    )
    .execute(pool)
    .await?;
    
    Ok(())
}

async fn remove_group_member(pool: &sqlx::PgPool, group_id: Uuid, person_id: Uuid) -> Result<(), AppError> {
    let result = sqlx::query!(
        "DELETE FROM group_members WHERE group_id = $1 AND person_id = $2",
        group_id, person_id
    )
    .execute(pool)
    .await?;
    
    if result.rows_affected() == 0 {
        return Err(AppError::NotFound);
    }
    
    Ok(())
}

async fn update_group_score(pool: &sqlx::PgPool, group_id: Uuid, user_id: Uuid, payload: GroupScoreChange) -> Result<GroupScoreRecord, AppError> {
    let mut tx = pool.begin().await?;
    let record_id = Uuid::new_v4();
    
    // 插入积分记录
    sqlx::query!(
        "INSERT INTO group_score_records (id, group_id, score_change, reason, created_by)
         VALUES ($1, $2, $3, $4, $5)",
        record_id, group_id, payload.score_change, payload.reason, user_id
    )
    .execute(&mut *tx)
    .await?;
    
    // 更新小组积分
    sqlx::query!(
        "UPDATE groups SET score = score + $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2",
        payload.score_change, group_id
    )
    .execute(&mut *tx)
    .await?;
    
    tx.commit().await?;
    
    // 获取创建的记录
    let record = sqlx::query_as::<_, GroupScoreRecord>(
        "SELECT id, group_id, score_change, reason, created_by, created_at 
         FROM group_score_records WHERE id = $1"
    )
    .bind(record_id)
    .fetch_one(pool)
    .await?;
    
    Ok(record)
}

async fn get_group_score_records(pool: &sqlx::PgPool, group_id: Uuid) -> Result<Vec<GroupScoreRecord>, AppError> {
    let records = sqlx::query_as::<_, GroupScoreRecord>(
        "SELECT id, group_id, score_change, reason, created_by, created_at 
         FROM group_score_records 
         WHERE group_id = $1 
         ORDER BY created_at DESC"
    )
    .bind(group_id)
    .fetch_all(pool)
    .await?;
    
    Ok(records)
}
```

### 3.3 路由配置

在 `backend/src/api/routes.rs` 文件中添加小组相关路由：

```rust
// 小组管理路由
let group_routes = Router::new()
    .route("/api/groups/class/:class_id", get(group::list))
    .route("/api/groups", post(group::create))
    .route("/api/groups/:id", get(group::get))
    .route("/api/groups/:id", put(group::update))
    .route("/api/groups/:id", delete(group::delete))
    .route("/api/groups/:id/members", get(group::get_members))
    .route("/api/groups/:id/members", post(group::add_member))
    .route("/api/groups/:id/members/:person_id", delete(group::remove_member))
    .route("/api/groups/:id/score", post(group::update_score))
    .route("/api/groups/:id/score-records", get(group::get_score_records));

// 将group_routes添加到主路由中
let app = Router::new()
    // 其他路由...
    .merge(group_routes);
```

### 3.4 权限配置

在 `backend/templates/permissions/teacher.yaml` 文件中添加小组管理权限：

```yaml
permissions:
  # 其他权限...
  - permission: "group.view"
    priority: 10
  - permission: "group.create"
    priority: 10
  - permission: "group.update"
    priority: 10
  - permission: "group.delete"
    priority: 10
  - permission: "group.update.member"
    priority: 10
  - permission: "group.update.score"
    priority: 10
```

在 `backend/templates/permissions/admin.yaml` 文件中添加小组管理权限：

```yaml
permissions:
  # 其他权限...
  - permission: "group.*"
    priority: 10
```

## 4. 前端实现

### 4.1 API 接口封装

在 `frontend/src/api/` 目录下创建 `group.ts` 文件：

```typescript
import { apiClient } from './index';

interface Group {
  id: string;
  class_id: string;
  class_name?: string;
  name: string;
  description?: string;
  score: number;
  member_count: number;
  created_at: string;
  updated_at: string;
}

interface GroupCreate {
  class_id: string;
  name: string;
  description?: string;
}

interface GroupUpdate {
  name?: string;
  description?: string;
}

interface GroupMemberAdd {
  person_id: string;
}

interface GroupScoreChange {
  score_change: number;
  reason: string;
}

interface GroupScoreRecord {
  id: string;
  group_id: string;
  score_change: number;
  reason: string;
  created_by: string;
  created_at: string;
}

export const groupApi = {
  // 获取班级的小组列表
  getGroupsByClass: async (classId: string): Promise<Group[]> => {
    const response = await apiClient.get(`/api/groups/class/${classId}`);
    return response.data;
  },

  // 创建小组
  createGroup: async (data: GroupCreate): Promise<Group> => {
    const response = await apiClient.post('/api/groups', data);
    return response.data;
  },

  // 获取小组详情
  getGroup: async (id: string): Promise<Group> => {
    const response = await apiClient.get(`/api/groups/${id}`);
    return response.data;
  },

  // 更新小组
  updateGroup: async (id: string, data: GroupUpdate): Promise<Group> => {
    const response = await apiClient.put(`/api/groups/${id}`, data);
    return response.data;
  },

  // 删除小组
  deleteGroup: async (id: string): Promise<void> => {
    await apiClient.delete(`/api/groups/${id}`);
  },

  // 获取小组成员
  getGroupMembers: async (id: string): Promise<any[]> => {
    const response = await apiClient.get(`/api/groups/${id}/members`);
    return response.data;
  },

  // 添加成员
  addGroupMember: async (id: string, data: GroupMemberAdd): Promise<void> => {
    await apiClient.post(`/api/groups/${id}/members`, data);
  },

  // 移除成员
  removeGroupMember: async (id: string, personId: string): Promise<void> => {
    await apiClient.delete(`/api/groups/${id}/members/${personId}`);
  },

  // 更新小组积分
  updateGroupScore: async (id: string, data: GroupScoreChange): Promise<GroupScoreRecord> => {
    const response = await apiClient.post(`/api/groups/${id}/score`, data);
    return response.data;
  },

  // 获取小组积分记录
  getGroupScoreRecords: async (id: string): Promise<GroupScoreRecord[]> => {
    const response = await apiClient.get(`/api/groups/${id}/score-records`);
    return response.data;
  },
};
```

### 4.2 前端组件

创建小组管理相关组件：

#### 4.2.1 小组列表组件

创建 `frontend/src/views/GroupManageView.vue`：

```vue
<template>
  <div class="group-manage">
    <h2>小组管理</h2>
    <div class="actions">
      <button @click="showCreateDialog = true" class="btn btn-primary" v-if="hasPermission('group.create')">
        创建小组
      </button>
    </div>
    
    <div class="group-list">
      <div v-for="group in groups" :key="group.id" class="group-card">
        <div class="group-header">
          <h3>{{ group.name }}</h3>
          <div class="score">积分: {{ group.score }}</div>
        </div>
        <div class="group-info">
          <p>{{ group.description || '无描述' }}</p>
          <p>成员数: {{ group.member_count }}</p>
        </div>
        <div class="group-actions">
          <button @click="viewGroup(group)" class="btn btn-info">查看</button>
          <button @click="editGroup(group)" class="btn btn-warning" v-if="hasPermission('group.update')">编辑</button>
          <button @click="deleteGroup(group)" class="btn btn-danger" v-if="hasPermission('group.delete')">删除</button>
        </div>
      </div>
    </div>
    
    <!-- 创建小组对话框 -->
    <el-dialog
      title="创建小组"
      v-model="showCreateDialog"
      width="500px"
    >
      <el-form :model="createForm" label-width="80px">
        <el-form-item label="小组名称">
          <el-input v-model="createForm.name" required></el-input>
        </el-form-item>
        <el-form-item label="描述">
          <el-input type="textarea" v-model="createForm.description"></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showCreateDialog = false">取消</el-button>
          <el-button type="primary" @click="submitCreate">确定</el-button>
        </span>
      </template>
    </el-dialog>
    
    <!-- 编辑小组对话框 -->
    <el-dialog
      title="编辑小组"
      v-model="showEditDialog"
      width="500px"
    >
      <el-form :model="editForm" label-width="80px">
        <el-form-item label="小组名称">
          <el-input v-model="editForm.name" required></el-input>
        </el-form-item>
        <el-form-item label="描述">
          <el-input type="textarea" v-model="editForm.description"></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showEditDialog = false">取消</el-button>
          <el-button type="primary" @click="submitEdit">确定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { groupApi } from '../api/group';
import { useRouter, useRoute } from 'vue-router';
import { hasPermission } from '../utils/permission';

const router = useRouter();
const route = useRoute();
const classId = route.params.id as string;

const groups = ref<Array<any>>([]);
const showCreateDialog = ref(false);
const showEditDialog = ref(false);

const createForm = ref({
  class_id: classId,
  name: '',
  description: ''
});

const editForm = ref({
  id: '',
  name: '',
  description: ''
});

onMounted(() => {
  loadGroups();
});

const loadGroups = async () => {
  try {
    groups.value = await groupApi.getGroupsByClass(classId);
  } catch (error) {
    console.error('加载小组失败:', error);
  }
};

const submitCreate = async () => {
  try {
    await groupApi.createGroup(createForm.value);
    showCreateDialog.value = false;
    createForm.value = {
      class_id: classId,
      name: '',
      description: ''
    };
    loadGroups();
  } catch (error) {
    console.error('创建小组失败:', error);
  }
};

const editGroup = (group: any) => {
  editForm.value = {
    id: group.id,
    name: group.name,
    description: group.description || ''
  };
  showEditDialog.value = true;
};

const submitEdit = async () => {
  try {
    await groupApi.updateGroup(editForm.value.id, {
      name: editForm.value.name,
      description: editForm.value.description
    });
    showEditDialog.value = false;
    loadGroups();
  } catch (error) {
    console.error('更新小组失败:', error);
  }
};

const deleteGroup = async (group: any) => {
  if (confirm(`确定要删除小组 ${group.name} 吗？`)) {
    try {
      await groupApi.deleteGroup(group.id);
      loadGroups();
    } catch (error) {
      console.error('删除小组失败:', error);
    }
  }
};

const viewGroup = (group: any) => {
  router.push(`/group/${group.id}`);
};
</script>

<style scoped>
.group-manage {
  padding: 20px;
}

.actions {
  margin-bottom: 20px;
}

.group-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.group-card {
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  padding: 16px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.group-header h3 {
  margin: 0;
  font-size: 18px;
}

.score {
  font-size: 16px;
  font-weight: bold;
  color: #409eff;
}

.group-info {
  margin-bottom: 16px;
  color: #606266;
}

.group-actions {
  display: flex;
  gap: 8px;
}
</style>
```

#### 4.2.2 小组详情组件

创建 `frontend/src/views/GroupDetailView.vue`：

```vue
<template>
  <div class="group-detail">
    <h2>小组详情 - {{ group.name }}</h2>
    
    <div class="group-info">
      <div class="info-item">
        <span class="label">小组名称:</span>
        <span class="value">{{ group.name }}</span>
      </div>
      <div class="info-item">
        <span class="label">所属班级:</span>
        <span class="value">{{ group.class_name }}</span>
      </div>
      <div class="info-item">
        <span class="label">积分:</span>
        <span class="value score">{{ group.score }}</span>
      </div>
      <div class="info-item">
        <span class="label">成员数:</span>
        <span class="value">{{ group.member_count }}</span>
      </div>
      <div class="info-item">
        <span class="label">描述:</span>
        <span class="value">{{ group.description || '无' }}</span>
      </div>
    </div>
    
    <!-- 成员管理 -->
    <div class="section">
      <h3>成员管理</h3>
      <div class="actions">
        <button @click="showAddMemberDialog = true" class="btn btn-primary" v-if="hasPermission('group.update.member')">
          添加成员
        </button>
      </div>
      <el-table :data="members" style="width: 100%">
        <el-table-column prop="name" label="姓名" />
        <el-table-column prop="student_no" label="学号" />
        <el-table-column label="操作" v-if="hasPermission('group.update.member')">
          <template #default="scope">
            <el-button type="danger" size="small" @click="removeMember(scope.row.id)">
              移除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    
    <!-- 积分管理 -->
    <div class="section">
      <h3>积分管理</h3>
      <div class="actions">
        <button @click="showScoreDialog = true" class="btn btn-primary" v-if="hasPermission('group.update.score')">
          修改积分
        </button>
      </div>
      <el-table :data="scoreRecords" style="width: 100%">
        <el-table-column prop="score_change" label="积分变化" />
        <el-table-column prop="reason" label="原因" />
        <el-table-column prop="created_at" label="时间" />
      </el-table>
    </div>
    
    <!-- 添加成员对话框 -->
    <el-dialog
      title="添加成员"
      v-model="showAddMemberDialog"
      width="500px"
    >
      <el-form :model="addMemberForm" label-width="80px">
        <el-form-item label="学生">
          <el-select v-model="addMemberForm.person_id" placeholder="选择学生" required>
            <el-option
              v-for="student in availableStudents"
              :key="student.id"
              :label="`${student.name} (${student.student_no})`"
              :value="student.id"
            />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showAddMemberDialog = false">取消</el-button>
          <el-button type="primary" @click="submitAddMember">确定</el-button>
        </span>
      </template>
    </el-dialog>
    
    <!-- 修改积分对话框 -->
    <el-dialog
      title="修改积分"
      v-model="showScoreDialog"
      width="500px"
    >
      <el-form :model="scoreForm" label-width="80px">
        <el-form-item label="积分变化">
          <el-input v-model.number="scoreForm.score_change" type="number" required>
            <template #append>
              <span>分</span>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item label="原因">
          <el-input type="textarea" v-model="scoreForm.reason" required></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showScoreDialog = false">取消</el-button>
          <el-button type="primary" @click="submitScoreChange">确定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { groupApi } from '../api/group';
import { personApi } from '../api/person';
import { useRoute } from 'vue-router';
import { hasPermission } from '../utils/permission';

const route = useRoute();
const groupId = route.params.id as string;

const group = ref<any>({
  id: '',
  name: '',
  class_id: '',
  class_name: '',
  score: 0,
  member_count: 0,
  description: ''
});

const members = ref<Array<any>>([]);
const availableStudents = ref<Array<any>>([]);
const scoreRecords = ref<Array<any>>([]);

const showAddMemberDialog = ref(false);
const showScoreDialog = ref(false);

const addMemberForm = ref({
  person_id: ''
});

const scoreForm = ref({
  score_change: 0,
  reason: ''
});

onMounted(() => {
  loadGroupDetail();
  loadMembers();
  loadScoreRecords();
  loadAvailableStudents();
});

const loadGroupDetail = async () => {
  try {
    group.value = await groupApi.getGroup(groupId);
  } catch (error) {
    console.error('加载小组详情失败:', error);
  }
};

const loadMembers = async () => {
  try {
    members.value = await groupApi.getGroupMembers(groupId);
  } catch (error) {
    console.error('加载成员失败:', error);
  }
};

const loadScoreRecords = async () => {
  try {
    scoreRecords.value = await groupApi.getGroupScoreRecords(groupId);
  } catch (error) {
    console.error('加载积分记录失败:', error);
  }
};

const loadAvailableStudents = async () => {
  try {
    // 获取班级的所有学生
    const classStudents = await personApi.getClassStudents(group.value.class_id);
    // 获取已在小组的学生ID
    const memberIds = members.value.map(m => m.id);
    // 过滤出不在小组中的学生
    availableStudents.value = classStudents.filter((s: any) => !memberIds.includes(s.id));
  } catch (error) {
    console.error('加载可用学生失败:', error);
  }
};

const submitAddMember = async () => {
  try {
    await groupApi.addGroupMember(groupId, addMemberForm.value);
    showAddMemberDialog.value = false;
    addMemberForm.value = { person_id: '' };
    loadMembers();
    loadAvailableStudents();
    loadGroupDetail();
  } catch (error) {
    console.error('添加成员失败:', error);
  }
};

const removeMember = async (personId: string) => {
  if (confirm('确定要移除该成员吗？')) {
    try {
      await groupApi.removeGroupMember(groupId, personId);
      loadMembers();
      loadAvailableStudents();
      loadGroupDetail();
    } catch (error) {
      console.error('移除成员失败:', error);
    }
  }
};

const submitScoreChange = async () => {
  try {
    await groupApi.updateGroupScore(groupId, scoreForm.value);
    showScoreDialog.value = false;
    scoreForm.value = { score_change: 0, reason: '' };
    loadScoreRecords();
    loadGroupDetail();
  } catch (error) {
    console.error('修改积分失败:', error);
  }
};
</script>

<style scoped>
.group-detail {
  padding: 20px;
}

.group-info {
  background: #f5f7fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.info-item {
  margin-bottom: 12px;
  display: flex;
  align-items: center;
}

.label {
  width: 100px;
  font-weight: bold;
  color: #606266;
}

.value {
  flex: 1;
}

.score {
  font-size: 24px;
  font-weight: bold;
  color: #409eff;
}

.section {
  margin-bottom: 30px;
}

.section h3 {
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e4e7ed;
}

.actions {
  margin-bottom: 16px;
}
</style>
```

### 4.3 路由配置

在 `frontend/src/router/index.ts` 中添加小组管理路由：

```typescript
import { createRouter, createWebHistory } from 'vue-router';
import GroupManageView from '../views/GroupManageView.vue';
import GroupDetailView from '../views/GroupDetailView.vue';

const routes = [
  // 其他路由...
  {
    path: '/class/:id/groups',
    name: 'GroupManage',
    component: GroupManageView,
    meta: { requiresAuth: true }
  },
  {
    path: '/group/:id',
    name: 'GroupDetail',
    component: GroupDetailView,
    meta: { requiresAuth: true }
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

export default router;
```

## 5. 权限管理

### 5.1 权限节点定义

在 `x:\works\code\ccccc\docs\权限组管理指南.md` 文件中添加小组权限节点：

#### 5.1.1 小组权限 (group)

| 权限节点 | 说明 |
|---------|------|
| `group.view` | 查看小组列表 |
| `group.create` | 创建小组 |
| `group.update` | 更新小组信息 |
| `group.delete` | 删除小组 |
| `group.update.member` | 管理小组成员 |
| `group.update.score` | 管理小组积分 |
| `group.*` | 所有小组权限（通配符） |

### 5.2 权限分配

#### 5.2.1 管理员权限组 (admin)
- 通配符权限：`group.*`

#### 5.2.2 教师权限组 (teacher)
- `group.view`
- `group.create`
- `group.update`
- `group.delete`
- `group.update.member`
- `group.update.score`

#### 5.2.3 学生权限组 (student)
- `group.view`

#### 5.2.4 家长权限组 (parent)
- `group.view`

## 6. 与现有功能的联动

### 6.1 与班级管理的联动
- 在班级详情页添加「小组管理」入口
- 班主任可以在班级内创建和管理小组
- 小组属于特定班级，不能跨班级操作

### 6.2 与人员管理的联动
- 小组成员只能是班级内的学生
- 在添加成员时，只能选择班级内的学生
- 学生可以同时属于多个小组

### 6.3 与权限管理的联动
- 使用现有的权限系统进行权限控制
- 只有班主任可以管理小组
- 学生和家长只能查看小组信息

## 7. 实现步骤

1. **创建数据库表**：执行 `006_create_group_tables.sql` 迁移脚本
2. **实现后端模型**：创建 `group.rs` 模型文件
3. **实现后端API**：创建 `group.rs` API文件，添加路由
4. **配置权限**：在权限模板中添加小组权限
5. **实现前端API封装**：创建 `group.ts` API文件
6. **实现前端组件**：创建小组管理和详情组件
7. **配置前端路由**：添加小组相关路由
8. **测试功能**：验证所有功能是否正常工作

## 8. 测试计划

### 8.1 功能测试
- 创建小组
- 编辑小组
- 删除小组
- 添加/移除成员
- 小组加分/减分
- 查看小组积分记录

### 8.2 权限测试
- 班主任可以管理小组
- 非班主任无法管理小组
- 学生只能查看小组信息
- 家长只能查看小组信息

### 8.3 边界测试
- 空小组名称
- 重复小组成员
- 积分变化为0
- 大量成员的小组

## 9. 总结

本开发文档详细说明了小组管理功能的实现方案，包括：
- 数据库结构设计
- 后端API实现
- 前端组件开发
- 权限管理配置
- 与现有功能的联动

通过本方案，班主任可以方便地在班级内创建和管理小组，进行小组成员管理和积分管理，提高班级管理的效率和趣味性。